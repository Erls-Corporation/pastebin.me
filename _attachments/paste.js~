Paste = function() {

  this.vars  = Paste.parse_query(document.location.href);

  this.state = ( this.vars && this.vars.paste )
    ? {NEW_POST:false, VIEW:"HTML", _id:this.vars.paste}
    : {NEW_POST:true,  VIEW:"CODE"};

  this.dom = {
    textarea: $("#code"),
    iframe:   $("#paste"),
    title:    $("#title"),
    viewcode: $("#viewcode"),
    form:     $("#form")
  };

  this.load_recent_posts();
  this.add_events();

  if( !this.state.NEW_POST ) {
    this.retrieve_post(this.state_id);
    this.dom.iframe.show();
    this.dom.viewcode.show();
  } else {
    this.dom.title.val("[Enter Title Here]");
    this.dom.textarea.show();
  }

  this.window_resize();
  // Just to get rid of annoying flash pre load
  $("#title, #templates, #save").show();
};

Paste.prototype.save_paste = function()
{
  var paste = {
    date:  (new Date()).getTime(),
    paste: this.dom.textarea.val(),
    title: this.dom.title.val()
  };

  $.post("/pastebin/", JSON.stringify(paste), function(data) {
    document.location.href= "?paste="+data.id;
  }, "json");
};

Paste.prototype.view_code = function()
{
  this.dom.textarea.show();
  this.dom.iframe.hide();
  this.dom.viewcode.hide();

  var that = this;
  setTimeout( function() {
    that.dom.textarea[0].focus();
  });
};

Paste.prototype.add_events = function()
{
  var that = this;

  $("#templates a").bind('mousedown', function(e) {
    that.load_template($(this).attr("name"));
    return false;
  });

  this.dom.form.bind('submit', function(e) {
    that.save_paste();
    e.preventDefault();
  });

  $(window).bind('resize', function(e) {
    that.window_resize();
  });

  this.dom.viewcode.bind('mousedown', function() {
    that.view_code();
  });

  this.dom.title.bind('focus', function() {
    if( $(this).val() == "[Enter Title Here]" ) {
      $(this).val("");
    }
  });
};

Paste.prototype.window_resize = function()
{
  $("#code, #paste").height($(window).height() - 116);
};

Paste.prototype.load_template = function(tpl)
{
  var that = this;
  var url  = "/pastebin/_design/pastebin.me/tpl/";

  $.get(url+tpl+".tpl", {}, function(data) {

    that.dom.textarea.val(data);
    if( that.state !== "CODE" ) {
      that.view_code();
    }

  }, "text");

};


Paste.prototype.load_recent_posts = function()
{
  var opts = { reduce: false, descending: true, limit:10 };
  var url  = "/pastebin/_design/pastebin.me/_view/example";

  $.get(url, opts, function(data) {
    $.each(data.rows, function() {
      var date = '<span class="subtle">('+ prettyDate(this.key) +')</a>';
      var link = '<li><a href="?paste=' + this.value.id+'">'
        +this.value.title+' '+date+'</a></li>';
      $("#postlist").append(link);
    });
  }, "json");
};

Paste.prototype.retrieve_post = function( id )
{
  var show = "/pastebin/_design/pastebin.me/_show/newshow/";

  var that = this;

  $.ajax({
    "url":"/pastebin/"+this.state._id,
    "dataType": "json",
    "success": function(data) {
      that.dom.title.val( data.title );
      that.dom.textarea.text( data.paste );
      that.dom.iframe.attr("src", show+that.state._id);
    },
    "error" : function(data) {
      that.view_code();
    }
  });
};

Paste.parse_query = function(url) {
  var qs = url.split("?")[1];
  if( typeof qs !== "undefined" ) {
    var arr = qs.split("&"), query = {};
    for( var i = 0; i < arr.length; i++ ) {
      var tmp = arr[i].split("=");
      query[tmp[0]] = tmp[1];
    }
    return query;
  }
  return false;
};

var p = new Paste();

